<div class="row">
	<div class="col m4">
		<div class="card z-depth-2">

			<% if !@joined %>
				<div class="card-content center">
					<h1><%= @project.price == 0 ? "FREE" : "$#{@project.price}" %></h1>
				</div>
				<div class="card-action center">
					<% if user_signed_in? %>
						<% if @project.price == 0 %>
							<%= form_tag free_path do %>
								<%= hidden_field_tag 'project_id', @project.id %>
								<button type="submit" class="btn pink darken-2">Take this project</button>
							<% end %>
						<% else %>	
							<%= form_tag pay_path, id: 'chargeForm' do %>
								<%= hidden_field_tag 'stripeToken' %>
								<%= hidden_field_tag 'stripeEmail' %>
								<%= hidden_field_tag 'project_id', @project.id %>
								<button id="customButton" type="button" class="btn pink darken-2">Take this project</button>

								<script>
								  var handler = StripeCheckout.configure({
								    key: '<%= Rails.configuration.stripe[:publishable_key] %>',
								    locale: 'auto',
								    token: function(token) {
								      // Use the token to create the charge with a server-side script.
								      // You can access the token ID with `token.id`
								      console.log(token);

								      $('#stripeToken').val(token.id);
								      $('#stripeEmail').val(token.email);
								      $('#chargeForm').submit();
								    }
								  });

								  $('#customButton').on('click', function(e) {
								    // Open Checkout with further options
								    handler.open({
								      name: 'Code4Pro',
								      description: '<%= @project.name %>',
								      amount: '<%= @project.price_in_cents %>',
								      email: '<%= current_user.email %>'
								    });
								    e.preventDefault();
								  });

								  // Close Checkout on page navigation
								  $(window).on('popstate', function() {
								    handler.close();
								  });
								</script>
							<% end %>
						<% end %>	
					<% else %>
						<%= link_to new_user_session_path do %>
							<button type="submit" class="btn pink darken-2">Take this project</button>				
						<% end %>
					<% end %>
				</div>
			<% else %>
				<div class="card-content center">
					<%= image_tag avatar_url(current_user), class: "circle responsive-img avatar" %><br/>
					<h5><%= current_user.name %></h5>
				</div>
				<div class="card-action center" style="overflow: hidden;">
					<% @users.each do |u| %>
						<span class="valign-wrapper">
							<%= image_tag avatar_url(u), class: "circle responsive-img avatar-small" %>&nbsp;
							<%= u.name %>&nbsp;
						</span><br/>
					<% end %>
				</div>	
			<% end %>

		</div>
	</div>

	<div class="col m8">
		<div class="card z-depth-2">
			<div class="card-image">
				<%= image_tag @project.image(:medium) %>
			</div>

			<div class="row">
		    <div class="col s12">
		      <ul class="tabs">
		        <li class="tab col s4"><a class="active" href="#about">About</a></li>
		        <li class="tab col s4"><a href="#videos">Videos</a></li>
		        <li class="tab col s4"><a href="#discussions">Discussions</a></li>
		      </ul>
		    </div>
	    
		    <div id="about" class="col s12">
					<div class="card-content grey-text text-darken-4">
						<h4><%= @project.name %></h4>
						<span id="average_rating"></span>
						<a href="#reviews_section">
							<p><%= pluralize(@reviews.count, 'review') %></p>
						</a>
						
						<hr>
						<%= @project.content %>

						<h5>Review</h5>
						<div><%= render 'reviews/form' if @joined && !@has_review %></div>
						<div id="reviews_section"><%= render 'reviews/index' %></div>
						
					</div>
		    </div>
		    <div id="videos" class="col s10 offset-s1">
					<div class="collection">
						<% @tasks.each do |task| %>
							<% if task.header? %>
								<div class="collection-item active">
									<i class="mdi-social-school"></i>
									<%= task.title %>
								</div>
							<% else %>
								<div class="collection-item">
									<%= link_to [task.project, task] do %>
										<%= task.title %>
									<% end %>
								</div>
							<% end %>
						<% end %>
					</div>
		    </div>
		    <div id="discussions" class="col s12">
		    	<!-- discussion will be here -->
		    </div>
    	</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	$('#average_rating').raty({
		path: '/assets',
		readOnly: true,
		score: <%= @project.average_rating %>
	});

	$(document).ready(function(){
    $('ul.tabs').tabs();
  });
</script>

